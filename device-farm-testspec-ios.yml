version: 0.1

# Based on working Appium 2.x examples from AWS re:Post and community
# https://repost.aws/questions/QUlK5xNrTmSgq54_VYH06Btg/how-to-work-with-appium-2-0-with-aws-device-farm

phases:
  install:
    commands:
      # Update Node.js for Appium 2.x compatibility (required for iOS 14+)
      - echo "=== Setting up Node.js 20 for Appium 2.x ==="
      - export NVM_DIR=$HOME/.nvm
      - . $NVM_DIR/nvm.sh
      - nvm install 20
      - nvm use 20
      - node --version
      - npm --version
      
      # Install Appium 2.x directly with npm
      - echo "=== Installing Appium 2.x ==="
      - npm install -g appium@2.1.2
      - appium --version
      
      # Install required Appium drivers
      - echo "=== Installing Appium XCUITest driver ==="
      - appium driver install xcuitest
      
      # Install test dependencies
      - echo "=== Installing test dependencies ==="
      - cd $DEVICEFARM_TEST_PACKAGE_PATH
      - npm install

  pre_test:
    commands:
      # Set up environment for Appium 2.x WebDriverAgent
      - echo "=== iOS Appium 2.x Pre-Test Setup ==="
      - echo "Device:" $DEVICEFARM_DEVICE_NAME
      - echo "Platform:" $DEVICEFARM_DEVICE_PLATFORM_NAME $DEVICEFARM_DEVICE_OS_VERSION
      - echo "App:" $DEVICEFARM_APP_PATH
      - echo "UDID:" $DEVICEFARM_DEVICE_UDID
      
      # Device Farm automatically sets the correct WDA derived data path for Appium 2.x
      - echo "WDA V8 Path (Appium 2.x):" $DEVICEFARM_WDA_DERIVED_DATA_PATH_V8
      
      # Start Appium server in background
      - echo "=== Starting Appium Server ==="
      - appium server --address 127.0.0.1 --port 4723 --base-path /wd/hub --log-level info &
      - sleep 5
      - echo "Appium server started on port 4723"

  test:
    commands:
      # Run WebDriverIO tests with Appium 2.x
      - echo "=== Running iOS Appium 2.x Tests ==="
      - cd $DEVICEFARM_TEST_PACKAGE_PATH
      - export TS_NODE_TRANSPILE_ONLY=true
      
      # Run the test command that should work with Device Farm
      - npx wdio config/wdio.ios.devicefarm.conf.ts

  post_test:
    commands:
      - echo "=== iOS Appium 2.x Test Completed ==="
      
      # Copy any generated reports
      - |
        if [ -d "allure-results" ]; then
          cp -r allure-results $DEVICEFARM_LOG_DIR/ 2>/dev/null || echo "Could not copy allure-results"
        fi
        if [ -d "screenshots" ]; then
          cp -r screenshots $DEVICEFARM_LOG_DIR/ 2>/dev/null || echo "Could not copy screenshots"
        fi

artifacts:
  - $DEVICEFARM_LOG_DIR
